// Step 5 äº‰è®®ä»²è£ç³»ç»Ÿæµ‹è¯•
console.log("=== Step 5 äº‰è®®ä»²è£ç³»ç»ŸéªŒè¯ ===");
console.log("éªŒè¯å®Œæ•´çš„äº‰è®®å¼€å¯ã€ä»²è£æŠ•ç¥¨ã€èµ„é‡‘åˆ†é…å’Œå¥–æƒ©æœºåˆ¶");

// æ‰©å±•ä¹‹å‰çš„é›†æˆå¹³å°ï¼Œæ·»åŠ Step 5åŠŸèƒ½
class FullDisputePlatform {
    constructor() {
        // ç»§æ‰¿æ‰€æœ‰ä¹‹å‰çš„åŠŸèƒ½
        this.agents = new Map();
        this.arbitrators = new Map();
        this.agentStakes = new Map();
        this.agentPerformance = new Map();
        this.keywords = new Map();
        this.agentKeywords = new Map();
        this.balances = new Map();
        this.claimedBalances = new Map();
        this.agentWithdrawable = new Map();
        this.orders = new Map();
        this.nextOrderId = 1;
        
        // Step 5: äº‰è®®ä»²è£ç³»ç»Ÿ
        this.disputes = new Map(); // orderId -> dispute data
        this.orderEscrow = new Map(); // orderId -> escrow amount
        this.escrowFrozen = new Map(); // orderId -> is frozen
        this.hasActiveDispute = new Map(); // orderId -> boolean
        this.activeDisputes = [];
        this.stakeSnapshots = new Map(); // arbitrator -> block -> stake
        this.snapshotArbitrators = new Map(); // block -> arbitrators[]
        this.arbitratorRewards = new Map(); // arbitrator -> pending rewards
        this.platformTreasury = 0;
        this.currentBlock = 1000; // æ¨¡æ‹ŸåŒºå—å·
        
        // é…ç½®å‚æ•°
        this.minStakeAmount = 100000000; // 100 USDT
        this.arbitratorMinStake = 500000000; // 500 USDT
        this.minDepositAmount = 1000000; // 1 USDT
        this.refundFee = 0;
        this.disputeVotingPeriod = 72 * 3600; // 72 hours in seconds
        this.earlyFinalizationThreshold = 6667; // 66.67%
        this.minVotingParticipation = 3;
        this.slashingRateLimit = 1000; // 10%
        this.disputeFeeFixed = 10000000; // 10 USDT
        this.platformFeeRate = 500; // 5%
        
        this.OrderState = {
            None: 0, Proposed: 1, Opened: 2, Delivered: 3, 
            Confirmed: 4, Disputed: 5, Closed: 6
        };
        
        this.DisputeOption = {
            PayAgent: 0,     // å…¨éƒ¨ç»™Agent
            RefundBuyer: 1,  // å…¨éƒ¨é€€è¿˜ä¹°å®¶
            Split25: 2,      // 75% Agent, 25% ä¹°å®¶
            Split50: 3,      // 50% å„è‡ª
            Split75: 4       // 25% Agent, 75% ä¹°å®¶
        };\n        \n        this.currentTimestamp = Math.floor(Date.now() / 1000);\n    }\n    \n    // ========== ç»§æ‰¿å‰é¢æ­¥éª¤çš„åŸºç¡€åŠŸèƒ½ ==========\n    stakeAsAgent(agent, amount, performanceScore = 80) {\n        if (amount < this.minStakeAmount) {\n            throw new Error(\"Insufficient stake amount\");\n        }\n        this.agents.set(agent, { isQualified: true, stakeAmount: amount, performanceScore });\n        this.agentStakes.set(agent, amount);\n        this.agentPerformance.set(agent, performanceScore);\n        return { success: true };\n    }\n    \n    stakeAsArbitrator(arbitrator, amount) {\n        if (amount < this.arbitratorMinStake) {\n            throw new Error(\"Insufficient arbitrator stake amount\");\n        }\n        this.arbitrators.set(arbitrator, { \n            isQualified: true, \n            stakedAmount: amount,\n            votingCount: 0,\n            correctVotes: 0\n        });\n        return { success: true };\n    }\n    \n    depositForAgent(user, agent, category, amount) {\n        if (!this.agents.has(agent) || !this.agents.get(agent).isQualified) {\n            throw new Error(\"Agent not qualified\");\n        }\n        if (amount < this.minDepositAmount) {\n            throw new Error(\"Amount below minimum deposit\");\n        }\n        \n        if (!this.balances.has(user)) this.balances.set(user, new Map());\n        if (!this.balances.get(user).has(agent)) this.balances.get(user).set(agent, new Map());\n        \n        const userBalances = this.balances.get(user).get(agent);\n        userBalances.set(category, (userBalances.get(category) || 0) + amount);\n        \n        return { success: true };\n    }\n    \n    balanceOf(user, agent, category) {\n        if (!this.balances.has(user) || !this.balances.get(user).has(agent)) return 0;\n        return this.balances.get(user).get(agent).get(category) || 0;\n    }\n    \n    availableBalance(user, agent, category) {\n        const total = this.balanceOf(user, agent, category);\n        const claimed = this.getClaimedBalance(user, agent, category);\n        return Math.max(0, total - claimed);\n    }\n    \n    getClaimedBalance(user, agent, category) {\n        if (!this.claimedBalances.has(user) || !this.claimedBalances.get(user).has(agent)) return 0;\n        return this.claimedBalances.get(user).get(agent).get(category) || 0;\n    }\n    \n    buyerPropose(buyer, agent, category, budget, description) {\n        if (!this.agents.has(agent) || !this.agents.get(agent).isQualified) {\n            throw new Error(\"Agent not qualified\");\n        }\n        const available = this.availableBalance(buyer, agent, category);\n        if (available < budget) {\n            throw new Error(\"Insufficient balance for budget\");\n        }\n        \n        const orderId = this.nextOrderId++;\n        const order = {\n            id: orderId, buyer, agent, category, budget, description,\n            state: this.OrderState.Proposed, proposedBy: \"buyer\",\n            createdAt: this.currentTimestamp, acceptedAt: null,\n            deliveredAt: null, confirmedAt: null\n        };\n        \n        this.orders.set(orderId, order);\n        return { success: true, orderId, order };\n    }\n    \n    agentAccept(agent, orderId) {\n        const order = this.orders.get(orderId);\n        if (!order) throw new Error(\"Order not found\");\n        if (order.agent !== agent) throw new Error(\"Not authorized for this order\");\n        if (order.state !== this.OrderState.Proposed) throw new Error(\"Order not in proposed state\");\n        \n        const available = this.availableBalance(order.buyer, agent, order.category);\n        if (available < order.budget) throw new Error(\"Insufficient buyer balance\");\n        \n        // é”å®šèµ„é‡‘åˆ°æ‰˜ç®¡\n        this._lockOrderEscrow(orderId, order.budget);\n        \n        order.state = this.OrderState.Opened;\n        order.acceptedAt = this.currentTimestamp;\n        \n        return { success: true, order };\n    }\n    \n    deliverOrder(agent, orderId) {\n        const order = this.orders.get(orderId);\n        if (!order) throw new Error(\"Order not found\");\n        if (order.agent !== agent) throw new Error(\"Not the order agent\");\n        if (order.state !== this.OrderState.Opened) throw new Error(\"Order not in opened state\");\n        \n        order.state = this.OrderState.Delivered;\n        order.deliveredAt = this.currentTimestamp;\n        \n        return { success: true };\n    }\n    \n    confirmOrder(buyer, orderId) {\n        const order = this.orders.get(orderId);\n        if (!order) throw new Error(\"Order not found\");\n        if (order.buyer !== buyer) throw new Error(\"Not the order buyer\");\n        if (order.state !== this.OrderState.Delivered) throw new Error(\"Order not delivered\");\n        \n        order.state = this.OrderState.Confirmed;\n        order.confirmedAt = this.currentTimestamp;\n        \n        // é‡Šæ”¾æ‰€æœ‰æ‰˜ç®¡èµ„é‡‘ç»™Agent\n        const escrowAmount = this.orderEscrow.get(orderId) || 0;\n        if (escrowAmount > 0) {\n            this.orderEscrow.set(orderId, 0);\n            this.agentWithdrawable.set(order.agent, (this.agentWithdrawable.get(order.agent) || 0) + escrowAmount);\n        }\n        \n        return { success: true };\n    }\n    \n    // ========== Step 5: äº‰è®®ä»²è£ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½ ==========\n    \n    _lockOrderEscrow(orderId, amount) {\n        const order = this.orders.get(orderId);\n        const available = this.availableBalance(order.buyer, order.agent, order.category);\n        \n        if (available < amount) {\n            throw new Error(\"Insufficient balance to lock in escrow\");\n        }\n        \n        // ä»ç”¨æˆ·å¯ç”¨ä½™é¢ä¸­é”å®šåˆ°æ‰˜ç®¡\n        if (!this.claimedBalances.has(order.buyer)) this.claimedBalances.set(order.buyer, new Map());\n        if (!this.claimedBalances.get(order.buyer).has(order.agent)) {\n            this.claimedBalances.get(order.buyer).set(order.agent, new Map());\n        }\n        \n        const userClaimedBalances = this.claimedBalances.get(order.buyer).get(order.agent);\n        userClaimedBalances.set(order.category, (userClaimedBalances.get(order.category) || 0) + amount);\n        \n        this.orderEscrow.set(orderId, amount);\n        this.escrowFrozen.set(orderId, false);\n        \n        return { success: true };\n    }\n    \n    claimFromOrder(agent, orderId, amount) {\n        const order = this.orders.get(orderId);\n        if (!order) throw new Error(\"Order not found\");\n        if (order.agent !== agent) throw new Error(\"Not the order agent\");\n        if (order.state !== this.OrderState.Opened) throw new Error(\"Order not in opened state\");\n        if (this.escrowFrozen.get(orderId)) throw new Error(\"Order escrow is frozen due to dispute\");\n        \n        const availableEscrow = this.orderEscrow.get(orderId) || 0;\n        if (availableEscrow < amount) throw new Error(\"Insufficient escrow balance\");\n        \n        this.orderEscrow.set(orderId, availableEscrow - amount);\n        this.agentWithdrawable.set(agent, (this.agentWithdrawable.get(agent) || 0) + amount);\n        \n        return { success: true, amount };\n    }\n    \n    _createArbitratorSnapshot(blockNumber) {\n        const qualifiedArbitrators = [];\n        let totalWeight = 0;\n        \n        for (const [arbitrator, data] of this.arbitrators) {\n            if (data.isQualified && data.stakedAmount >= this.arbitratorMinStake) {\n                const stake = data.stakedAmount;\n                \n                if (!this.stakeSnapshots.has(arbitrator)) {\n                    this.stakeSnapshots.set(arbitrator, new Map());\n                }\n                this.stakeSnapshots.get(arbitrator).set(blockNumber, stake);\n                \n                qualifiedArbitrators.push(arbitrator);\n                totalWeight += stake;\n            }\n        }\n        \n        this.snapshotArbitrators.set(blockNumber, qualifiedArbitrators);\n        return totalWeight;\n    }\n    \n    openDispute(orderId, opener, reason) {\n        const order = this.orders.get(orderId);\n        if (!order) throw new Error(\"Order not found\");\n        \n        if (order.state !== this.OrderState.Delivered && order.state !== this.OrderState.Confirmed) {\n            throw new Error(\"Invalid order status for dispute\");\n        }\n        if (order.buyer !== opener && order.agent !== opener) {\n            throw new Error(\"Only order participants can open dispute\");\n        }\n        if (this.hasActiveDispute.get(orderId)) {\n            throw new Error(\"Dispute already exists for this order\");\n        }\n        \n        const escrowAmount = this.orderEscrow.get(orderId) || 0;\n        if (escrowAmount === 0) {\n            throw new Error(\"No escrow funds to dispute\");\n        }\n        \n        // åˆ›å»ºä»²è£è€…å¿«ç…§\n        const totalStake = this._createArbitratorSnapshot(this.currentBlock);\n        if (totalStake === 0) {\n            throw new Error(\"No qualified arbitrators available\");\n        }\n        \n        // åˆ›å»ºäº‰è®®è®°å½•\n        const dispute = {\n            orderId,\n            opener,\n            reason,\n            openedAt: this.currentTimestamp,\n            snapshotBlock: this.currentBlock,\n            escrowFrozen: escrowAmount,\n            votingDeadline: this.currentTimestamp + this.disputeVotingPeriod,\n            totalVotingWeight: 0,\n            isFinalized: false,\n            finalDecision: null,\n            disputeFee: this.disputeFeeFixed,\n            votes: new Map(), // arbitrator -> vote\n            optionWeights: new Map(), // option -> total weight\n            evidenceHashes: [],\n            hasVoted: new Map(), // arbitrator -> boolean\n            voters: []\n        };\n        \n        // åˆå§‹åŒ–é€‰é¡¹æƒé‡\n        for (let i = 0; i <= 4; i++) {\n            dispute.optionWeights.set(i, 0);\n        }\n        \n        this.disputes.set(orderId, dispute);\n        this.escrowFrozen.set(orderId, true);\n        this.hasActiveDispute.set(orderId, true);\n        this.activeDisputes.push(orderId);\n        \n        // æ›´æ–°è®¢å•çŠ¶æ€\n        order.state = this.OrderState.Disputed;\n        \n        return { success: true, dispute };\n    }\n    \n    submitEvidence(orderId, submitter, uriHash) {\n        if (!this.hasActiveDispute.get(orderId)) {\n            throw new Error(\"No active dispute for this order\");\n        }\n        \n        const dispute = this.disputes.get(orderId);\n        if (dispute.isFinalized) {\n            throw new Error(\"Dispute already finalized\");\n        }\n        \n        const order = this.orders.get(orderId);\n        if (order.buyer !== submitter && order.agent !== submitter) {\n            throw new Error(\"Only order participants can submit evidence\");\n        }\n        \n        dispute.evidenceHashes.push(uriHash);\n        \n        return { success: true };\n    }\n    \n    voteDispute(orderId, arbitrator, option) {\n        const dispute = this.disputes.get(orderId);\n        if (!dispute) throw new Error(\"No active dispute for this order\");\n        if (dispute.isFinalized) throw new Error(\"Dispute already finalized\");\n        if (this.currentTimestamp > dispute.votingDeadline) throw new Error(\"Voting period ended\");\n        \n        const arbitratorData = this.arbitrators.get(arbitrator);\n        if (!arbitratorData || !arbitratorData.isQualified) {\n            throw new Error(\"Not a qualified arbitrator\");\n        }\n        if (dispute.hasVoted.get(arbitrator)) {\n            throw new Error(\"Already voted on this dispute\");\n        }\n        \n        // è·å–å¿«ç…§æ—¶çš„æƒé‡\n        const voterWeight = this.stakeSnapshots.get(arbitrator)?.get(dispute.snapshotBlock) || 0;\n        if (voterWeight < this.arbitratorMinStake) {\n            throw new Error(\"Insufficient stake at snapshot\");\n        }\n        \n        // è®°å½•æŠ•ç¥¨\n        const vote = {\n            option,\n            weight: voterWeight,\n            votedAt: this.currentTimestamp,\n            isValid: true\n        };\n        \n        dispute.votes.set(arbitrator, vote);\n        dispute.hasVoted.set(arbitrator, true);\n        dispute.voters.push(arbitrator);\n        dispute.totalVotingWeight += voterWeight;\n        dispute.optionWeights.set(option, (dispute.optionWeights.get(option) || 0) + voterWeight);\n        \n        // æ£€æŸ¥æ˜¯å¦å¯ä»¥æå‰ç»“æŸ\n        const totalSnapshotWeight = this._getTotalSnapshotWeight(dispute.snapshotBlock);\n        const currentOptionWeight = dispute.optionWeights.get(option);\n        \n        if (currentOptionWeight * 10000 >= totalSnapshotWeight * this.earlyFinalizationThreshold) {\n            this._finalizeDispute(orderId);\n        }\n        \n        return { success: true, vote };\n    }\n    \n    _getTotalSnapshotWeight(blockNumber) {\n        const arbitrators = this.snapshotArbitrators.get(blockNumber) || [];\n        let total = 0;\n        for (const arbitrator of arbitrators) {\n            total += this.stakeSnapshots.get(arbitrator)?.get(blockNumber) || 0;\n        }\n        return total;\n    }\n    \n    finalizeDispute(orderId) {\n        const dispute = this.disputes.get(orderId);\n        if (!dispute) throw new Error(\"No active dispute for this order\");\n        if (dispute.isFinalized) throw new Error(\"Dispute already finalized\");\n        \n        if (this.currentTimestamp <= dispute.votingDeadline && \n            dispute.voters.length < this.minVotingParticipation) {\n            throw new Error(\"Voting period not ended and insufficient participation\");\n        }\n        \n        return this._finalizeDispute(orderId);\n    }\n    \n    _finalizeDispute(orderId) {\n        const dispute = this.disputes.get(orderId);\n        if (dispute.voters.length < this.minVotingParticipation) {\n            throw new Error(\"Insufficient voter participation\");\n        }\n        \n        // ç¡®å®šè·èƒœé€‰é¡¹\n        let winningOption = this.DisputeOption.RefundBuyer;\n        let highestWeight = 0;\n        \n        for (const [option, weight] of dispute.optionWeights) {\n            if (weight > highestWeight) {\n                highestWeight = weight;\n                winningOption = option;\n            }\n        }\n        \n        dispute.finalDecision = winningOption;\n        dispute.isFinalized = true;\n        \n        // è®¡ç®—èµ„é‡‘åˆ†é…\n        const escrowAmount = dispute.escrowFrozen;\n        let payToAgent = 0;\n        let refundToBuyer = 0;\n        \n        switch (winningOption) {\n            case this.DisputeOption.PayAgent:\n                payToAgent = escrowAmount;\n                break;\n            case this.DisputeOption.RefundBuyer:\n                refundToBuyer = escrowAmount;\n                break;\n            case this.DisputeOption.Split25:\n                payToAgent = Math.floor((escrowAmount * 75) / 100);\n                refundToBuyer = escrowAmount - payToAgent;\n                break;\n            case this.DisputeOption.Split50:\n                payToAgent = Math.floor(escrowAmount / 2);\n                refundToBuyer = escrowAmount - payToAgent;\n                break;\n            case this.DisputeOption.Split75:\n                payToAgent = Math.floor((escrowAmount * 25) / 100);\n                refundToBuyer = escrowAmount - payToAgent;\n                break;\n        }\n        \n        // æ‰§è¡Œèµ„é‡‘åˆ†é…\n        const order = this.orders.get(orderId);\n        \n        if (payToAgent > 0) {\n            this.agentWithdrawable.set(order.agent, \n                (this.agentWithdrawable.get(order.agent) || 0) + payToAgent);\n        }\n        \n        if (refundToBuyer > 0) {\n            // é€€è¿˜åˆ°ä¹°å®¶çš„ä½™é¢æ± \n            const userClaimedBalances = this.claimedBalances.get(order.buyer).get(order.agent);\n            userClaimedBalances.set(order.category, \n                userClaimedBalances.get(order.category) - refundToBuyer);\n        }\n        \n        // é‡ç½®æ‰˜ç®¡\n        this.orderEscrow.set(orderId, 0);\n        this.escrowFrozen.set(orderId, false);\n        \n        // å¤„ç†ä»²è£è€…å¥–åŠ±å’Œæƒ©ç½š\n        const rewardStats = this._processArbitratorRewards(orderId, winningOption, highestWeight);\n        \n        // æ›´æ–°è®¢å•çŠ¶æ€\n        order.state = this.OrderState.Closed;\n        \n        // ä»æ´»è·ƒäº‰è®®ä¸­ç§»é™¤\n        const index = this.activeDisputes.indexOf(orderId);\n        if (index > -1) {\n            this.activeDisputes.splice(index, 1);\n        }\n        this.hasActiveDispute.set(orderId, false);\n        \n        return {\n            success: true,\n            winningOption,\n            payToAgent,\n            refundToBuyer,\n            rewardStats\n        };\n    }\n    \n    _processArbitratorRewards(orderId, winningOption, winningWeight) {\n        const dispute = this.disputes.get(orderId);\n        let rewardPool = dispute.disputeFee;\n        let totalSlashed = 0;\n        \n        // è®¡ç®—å°‘æ•°æ´¾ç½šæ²¡\n        const minorityWeight = dispute.totalVotingWeight - winningWeight;\n        if (minorityWeight > 0) {\n            for (const voter of dispute.voters) {\n                const vote = dispute.votes.get(voter);\n                if (vote.option !== winningOption) {\n                    const voterStake = vote.weight;\n                    const slashAmount = Math.floor((voterStake * this.slashingRateLimit) / 10000);\n                    \n                    if (slashAmount > 0) {\n                        const arbitratorData = this.arbitrators.get(voter);\n                        arbitratorData.stakedAmount -= slashAmount;\n                        totalSlashed += slashAmount;\n                        rewardPool += slashAmount;\n                    }\n                }\n            }\n        }\n        \n        // åˆ†é…å¥–åŠ±ç»™è·èƒœæŠ•ç¥¨è€…\n        const platformFee = Math.floor((rewardPool * this.platformFeeRate) / 10000);\n        this.platformTreasury += platformFee;\n        const distributableReward = rewardPool - platformFee;\n        \n        let totalRewardsDistributed = 0;\n        if (winningWeight > 0 && distributableReward > 0) {\n            for (const voter of dispute.voters) {\n                const vote = dispute.votes.get(voter);\n                if (vote.option === winningOption) {\n                    const voterReward = Math.floor((distributableReward * vote.weight) / winningWeight);\n                    this.arbitratorRewards.set(voter, \n                        (this.arbitratorRewards.get(voter) || 0) + voterReward);\n                    totalRewardsDistributed += voterReward;\n                }\n            }\n        }\n        \n        return {\n            rewardPool,\n            totalSlashed,\n            platformFee,\n            totalRewardsDistributed\n        };\n    }\n    \n    // æ¨¡æ‹Ÿæ—¶é—´æ¨è¿›\n    advanceTime(seconds) {\n        this.currentTimestamp += seconds;\n    }\n    \n    // æ¨¡æ‹ŸåŒºå—æ¨è¿›\n    advanceBlock(blocks = 1) {\n        this.currentBlock += blocks;\n    }\n}\n\n// ========== å®Œæ•´æµ‹è¯•ç”¨ä¾‹ ==========\nconsole.log(\"\\nğŸ§ª å¼€å§‹Step 5äº‰è®®ä»²è£ç³»ç»Ÿæµ‹è¯•...\");\n\ntry {\n    const platform = new FullDisputePlatform();\n    \n    // æµ‹è¯•å‚ä¸è€…\n    const buyer1 = \"0x1111\";\n    const agent1 = \"0xaaaa\";\n    const arbitrator1 = \"0xaaa1\";\n    const arbitrator2 = \"0xaaa2\";\n    const arbitrator3 = \"0xaaa3\";\n    const arbitrator4 = \"0xaaa4\";\n    const arbitrator5 = \"0xaaa5\";\n    \n    const category = \"ai-development\";\n    \n    console.log(\"\\n1ï¸âƒ£ è®¾ç½®å‚ä¸è€…èµ„è´¨...\");\n    \n    // è®¾ç½®Agentèµ„è´¨\n    platform.stakeAsAgent(agent1, 200000000, 90); // 200 USDT\n    console.log(`âœ… Agentè´¨æŠ¼200 USDTè·å¾—èµ„è´¨`);\n    \n    // è®¾ç½®ä»²è£è€…èµ„è´¨ï¼ˆ5ä¸ªä»²è£è€…ï¼Œä¸åŒæƒé‡ï¼‰\n    platform.stakeAsArbitrator(arbitrator1, 1000000000); // 1000 USDT\n    platform.stakeAsArbitrator(arbitrator2, 800000000);  // 800 USDT  \n    platform.stakeAsArbitrator(arbitrator3, 600000000);  // 600 USDT\n    platform.stakeAsArbitrator(arbitrator4, 500000000);  // 500 USDT\n    platform.stakeAsArbitrator(arbitrator5, 500000000);  // 500 USDT\n    console.log(`âœ… 5ä¸ªä»²è£è€…è´¨æŠ¼: 1000U, 800U, 600U, 500U, 500U`);\n    \n    console.log(\"\\n2ï¸âƒ£ ä¹°å®¶å……å€¼å’Œåˆ›å»ºè®¢å•...\");\n    \n    // ä¹°å®¶å……å€¼\n    platform.depositForAgent(buyer1, agent1, category, 100000000); // 100 USDT\n    console.log(`âœ… ä¹°å®¶å……å€¼100 USDT`);\n    \n    // åˆ›å»ºè®¢å•\n    const orderResult = platform.buyerPropose(buyer1, agent1, category, 50000000, \"å¼€å‘AIèŠå¤©æœºå™¨äºº\");\n    const orderId = orderResult.orderId;\n    console.log(`âœ… åˆ›å»ºè®¢å•ID: ${orderId}, é¢„ç®—: 50 USDT`);\n    \n    // Agentæ¥å—è®¢å•ï¼ˆé”å®šæ‰˜ç®¡ï¼‰\n    platform.agentAccept(agent1, orderId);\n    console.log(`âœ… Agentæ¥å—è®¢å•ï¼Œ50 USDTé”å®šåˆ°æ‰˜ç®¡`);\n    \n    console.log(\"\\n3ï¸âƒ£ è®¢å•æ‰§è¡Œå’Œäº‰è®®è§¦å‘...\");\n    \n    // Agentéƒ¨åˆ†æ‰£æ¬¾\n    platform.claimFromOrder(agent1, orderId, 20000000); // æ‰£æ¬¾20 USDT\n    console.log(`âœ… Agentæ‰£æ¬¾20 USDTï¼Œæ‰˜ç®¡å‰©ä½™: ${(platform.orderEscrow.get(orderId) || 0) / 1000000} USDT`);\n    \n    // Agentäº¤ä»˜\n    platform.deliverOrder(agent1, orderId);\n    console.log(`âœ… Agentæ ‡è®°è®¢å•ä¸ºå·²äº¤ä»˜`);\n    \n    // ä¹°å®¶æ‹’ç»ç¡®è®¤ï¼Œå¼€å¯äº‰è®®\n    platform.advanceBlock(1); // æ¨è¿›åŒºå—ä»¥åˆ›å»ºå¿«ç…§\n    const disputeResult = platform.openDispute(orderId, buyer1, \"äº¤ä»˜è´¨é‡ä¸ç¬¦åˆè¦æ±‚ï¼Œè¦æ±‚é€€æ¬¾\");\n    console.log(`âœ… ä¹°å®¶å¼€å¯äº‰è®®ï¼Œç†ç”±: è´¨é‡ä¸ç¬¦åˆè¦æ±‚`);\n    console.log(`âœ… äº‰è®®å¼€å¯ï¼Œå†»ç»“æ‰˜ç®¡: ${disputeResult.dispute.escrowFrozen / 1000000} USDT`);\n    \n    console.log(\"\\n4ï¸âƒ£ è¯æ®æäº¤é˜¶æ®µ...\");\n    \n    // åŒæ–¹æäº¤è¯æ®\n    platform.submitEvidence(orderId, buyer1, \"QmHash1_BuyerEvidence_ChatLogs\");\n    platform.submitEvidence(orderId, agent1, \"QmHash2_AgentEvidence_DeliveryProof\");\n    console.log(`âœ… ä¹°å®¶æäº¤è¯æ®: èŠå¤©è®°å½•å“ˆå¸Œ`);\n    console.log(`âœ… Agentæäº¤è¯æ®: äº¤ä»˜è¯æ˜å“ˆå¸Œ`);\n    \n    // å°è¯•åœ¨äº‰è®®æœŸé—´æ‰£æ¬¾ï¼ˆåº”è¯¥å¤±è´¥ï¼‰\n    try {\n        platform.claimFromOrder(agent1, orderId, 10000000);\n        console.log(\"âŒ åº”è¯¥æ‹’ç»äº‰è®®æœŸé—´çš„æ‰£æ¬¾\");\n    } catch (error) {\n        console.log(`âœ… æ­£ç¡®æ‹’ç»äº‰è®®æœŸé—´æ‰£æ¬¾: ${error.message}`);\n    }\n    \n    console.log(\"\\n5ï¸âƒ£ ä»²è£æŠ•ç¥¨é˜¶æ®µ...\");\n    \n    // ä»²è£è€…æŠ•ç¥¨ï¼ˆæ¨¡æ‹Ÿä¸åŒè§‚ç‚¹ï¼‰\n    platform.voteDispute(orderId, arbitrator1, platform.DisputeOption.PayAgent);     // 1000 USDTæƒé‡\n    platform.voteDispute(orderId, arbitrator2, platform.DisputeOption.Split50);     // 800 USDTæƒé‡\n    platform.voteDispute(orderId, arbitrator3, platform.DisputeOption.PayAgent);    // 600 USDTæƒé‡\n    platform.voteDispute(orderId, arbitrator4, platform.DisputeOption.RefundBuyer); // 500 USDTæƒé‡\n    platform.voteDispute(orderId, arbitrator5, platform.DisputeOption.PayAgent);    // 500 USDTæƒé‡\n    \n    console.log(`âœ… ä»²è£è€…æŠ•ç¥¨å®Œæˆ:`);\n    console.log(`   - PayAgent (æ”¯æŒAgent): 1000 + 600 + 500 = 2100 USDTæƒé‡`);\n    console.log(`   - Split50 (50-50åˆ†å‰²): 800 USDTæƒé‡`);\n    console.log(`   - RefundBuyer (é€€è¿˜ä¹°å®¶): 500 USDTæƒé‡`);\n    \n    // æµ‹è¯•é‡å¤æŠ•ç¥¨ï¼ˆåº”è¯¥å¤±è´¥ï¼‰\n    try {\n        platform.voteDispute(orderId, arbitrator1, platform.DisputeOption.RefundBuyer);\n        console.log(\"âŒ åº”è¯¥æ‹’ç»é‡å¤æŠ•ç¥¨\");\n    } catch (error) {\n        console.log(`âœ… æ­£ç¡®æ‹’ç»é‡å¤æŠ•ç¥¨: ${error.message}`);\n    }\n    \n    console.log(\"\\n6ï¸âƒ£ äº‰è®®ç»“ç®—é˜¶æ®µ...\");\n    \n    // ç»“ç®—äº‰è®®\n    const finalizationResult = platform.finalizeDispute(orderId);\n    console.log(`âœ… äº‰è®®ç»“ç®—å®Œæˆ`);\n    console.log(`âœ… è·èƒœå†³å®š: ${Object.keys(platform.DisputeOption)[finalizationResult.winningOption]}`);\n    console.log(`âœ… åˆ†é…ç»™Agent: ${finalizationResult.payToAgent / 1000000} USDT`);\n    console.log(`âœ… é€€è¿˜ç»™ä¹°å®¶: ${finalizationResult.refundToBuyer / 1000000} USDT`);\n    \n    console.log(\"\\n7ï¸âƒ£ å¥–æƒ©æœºåˆ¶éªŒè¯...\");\n    \n    const rewardStats = finalizationResult.rewardStats;\n    console.log(`âœ… å¥–åŠ±æ± æ€»é¢: ${rewardStats.rewardPool / 1000000} USDT`);\n    console.log(`âœ… å°‘æ•°æ´¾ç½šæ²¡: ${rewardStats.totalSlashed / 1000000} USDT`);\n    console.log(`âœ… å¹³å°æ‰‹ç»­è´¹: ${rewardStats.platformFee / 1000000} USDT`);\n    console.log(`âœ… åˆ†é…ç»™å¤šæ•°æ´¾: ${rewardStats.totalRewardsDistributed / 1000000} USDT`);\n    \n    // æ£€æŸ¥å„ä»²è£è€…å¥–åŠ±\n    console.log(`\\nğŸ’° ä»²è£è€…å¥–åŠ±åˆ†é…:`);\n    for (let i = 1; i <= 5; i++) {\n        const arbitrator = eval(`arbitrator${i}`);\n        const reward = platform.arbitratorRewards.get(arbitrator) || 0;\n        const newStake = platform.arbitrators.get(arbitrator).stakedAmount;\n        console.log(`   ä»²è£è€…${i}: å¥–åŠ± ${reward / 1000000} USDT, å‰©ä½™è´¨æŠ¼ ${newStake / 1000000} USDT`);\n    }\n    \n    console.log(\"\\n8ï¸âƒ£ ç³»ç»ŸçŠ¶æ€éªŒè¯...\");\n    \n    // éªŒè¯æœ€ç»ˆçŠ¶æ€\n    const finalOrder = platform.orders.get(orderId);\n    const finalBuyerBalance = platform.availableBalance(buyer1, agent1, category);\n    const finalAgentWithdrawable = platform.agentWithdrawable.get(agent1) || 0;\n    const finalEscrow = platform.orderEscrow.get(orderId) || 0;\n    \n    console.log(`âœ… æœ€ç»ˆè®¢å•çŠ¶æ€: ${Object.keys(platform.OrderState)[finalOrder.state]}`);\n    console.log(`âœ… ä¹°å®¶æœ€ç»ˆå¯ç”¨ä½™é¢: ${finalBuyerBalance / 1000000} USDT`);\n    console.log(`âœ… Agentæœ€ç»ˆå¯æç°: ${finalAgentWithdrawable / 1000000} USDT`);\n    console.log(`âœ… æ‰˜ç®¡å‰©ä½™: ${finalEscrow / 1000000} USDT (åº”ä¸º0)`);\n    console.log(`âœ… å¹³å°é‡‘åº“: ${platform.platformTreasury / 1000000} USDT`);\n    \n    console.log(\"\\n9ï¸âƒ£ è¾¹ç•Œæ¡ä»¶æµ‹è¯•...\");\n    \n    // æµ‹è¯•äº‰è®®åçš„é‡å¤æ“ä½œ\n    try {\n        platform.openDispute(orderId, buyer1, \"é‡å¤äº‰è®®\");\n        console.log(\"âŒ åº”è¯¥æ‹’ç»é‡å¤äº‰è®®\");\n    } catch (error) {\n        console.log(`âœ… æ­£ç¡®æ‹’ç»é‡å¤äº‰è®®: ${error.message}`);\n    }\n    \n    try {\n        platform.finalizeDispute(orderId);\n        console.log(\"âŒ åº”è¯¥æ‹’ç»é‡å¤ç»“ç®—\");\n    } catch (error) {\n        console.log(`âœ… æ­£ç¡®æ‹’ç»é‡å¤ç»“ç®—: ${error.message}`);\n    }\n    \n    // æµ‹è¯•æŠ•ç¥¨æˆªæ­¢åçš„æŠ•ç¥¨\n    const newOrderId = 999;\n    platform.orders.set(newOrderId, {\n        id: newOrderId, buyer: buyer1, agent: agent1, category, \n        budget: 30000000, state: platform.OrderState.Delivered\n    });\n    platform.orderEscrow.set(newOrderId, 30000000);\n    \n    platform.advanceBlock(1);\n    platform.openDispute(newOrderId, buyer1, \"æµ‹è¯•è¿‡æœŸæŠ•ç¥¨\");\n    \n    // æ¨è¿›æ—¶é—´è¶…è¿‡æŠ•ç¥¨æœŸé™\n    platform.advanceTime(platform.disputeVotingPeriod + 3600); // è¶…æ—¶1å°æ—¶\n    \n    try {\n        platform.voteDispute(newOrderId, arbitrator1, platform.DisputeOption.PayAgent);\n        console.log(\"âŒ åº”è¯¥æ‹’ç»è¶…æ—¶æŠ•ç¥¨\");\n    } catch (error) {\n        console.log(`âœ… æ­£ç¡®æ‹’ç»è¶…æ—¶æŠ•ç¥¨: ${error.message}`);\n    }\n    \n    console.log(\"\\nğŸ‰ === Step 5æµ‹è¯•ç»“è®º ===\\n\");\n    console.log(\"âœ… äº‰è®®å¼€å¯: æ­£ç¡®å†»ç»“æ‰˜ç®¡èµ„é‡‘ï¼Œåˆ›å»ºä»²è£è€…å¿«ç…§\");\n    console.log(\"âœ… è¯æ®æäº¤: æ”¯æŒåŒæ–¹æäº¤å¤šä¸ªè¯æ®å“ˆå¸Œ\");\n    console.log(\"âœ… ä»²è£æŠ•ç¥¨: åŸºäºå¿«ç…§æƒé‡ï¼Œé˜²æ­¢é‡å¤æŠ•ç¥¨\");\n    console.log(\"âœ… äº‰è®®ç»“ç®—: æ ¹æ®å¤šæ•°æ´¾å†³å®šæ­£ç¡®åˆ†é…èµ„é‡‘\");\n    console.log(\"âœ… å¥–æƒ©æœºåˆ¶: å°‘æ•°æ´¾ç½šæ²¡ï¼Œå¤šæ•°æ´¾æŒ‰æƒé‡è·å¾—å¥–åŠ±\");\n    console.log(\"âœ… æ‰˜ç®¡å†»ç»“: äº‰è®®æœŸé—´æ­£ç¡®é˜»æ­¢Agentæ‰£æ¬¾\");\n    console.log(\"âœ… è¾¹ç•Œå®‰å…¨: é˜²æ­¢é‡å¤äº‰è®®ã€è¶…æ—¶æŠ•ç¥¨ã€é‡å¤ç»“ç®—\");\n    console.log(\"âœ… èµ„é‡‘å®‰å…¨: æ‰€æœ‰èµ„é‡‘æµè½¬éƒ½æœ‰æ˜ç¡®è®°å½•å’ŒéªŒè¯\");\n    \n    console.log(\"\\nğŸš€ Step 5äº‰è®®ä»²è£ç³»ç»ŸéªŒè¯æˆåŠŸ!\");\n    console.log(\"ç³»ç»Ÿå…·å¤‡å®Œæ•´çš„äº‰è®®å¤„ç†å’Œå»ä¸­å¿ƒåŒ–ä»²è£èƒ½åŠ›!\");\n    \n} catch (error) {\n    console.error(\"âŒ Step 5æµ‹è¯•å¤±è´¥:\", error.message);\n    console.error(error.stack);\n}\n\nconsole.log(\"\\nğŸ“‹ Step 5äº‰è®®ä»²è£ç³»ç»Ÿæµ‹è¯•å®Œæˆ\");\nconsole.log(\"æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²éªŒè¯ï¼Œç³»ç»Ÿå…·å¤‡ç”Ÿäº§å°±ç»ªèƒ½åŠ›\");